<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Facility Management Hub</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --nav-bg: #252525;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent-idle: #03dac6;
            --accent-occupied: #96cb39;
            --accent-warning: #cf6679;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Navigation Tabs */
        nav {
            background: var(--nav-bg);
            display: flex;
            justify-content: center;
            padding: 10px;
            gap: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: bold;
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-btn.active {
            color: var(--accent-idle);
            border-bottom-color: var(--accent-idle);
        }

        .view-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .view-content.active {
            display: block;
        }

        /* LIVE STATUS GRID (2x2) */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            height: 100%;
            box-sizing: border-box;
        }

        .mini-card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: border-color 0.5s, transform 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .mini-card.occupied-state { border-color: var(--accent-occupied); }
        .mini-card.warning-state { border-color: var(--accent-warning); }

        .mini-label { font-size: 0.9rem; font-weight: 700; letter-spacing: 3px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .mini-title { font-size: 1.8rem; font-weight: bold; margin: 10px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-timer { font-size: 3.5rem; font-weight: bold; font-variant-numeric: tabular-nums; letter-spacing: -2px; }
        .mini-range { font-size: 1rem; color: var(--text-muted); margin-top: 10px; }

        /* DAILY SCHEDULE GRID (4 Columns) */
        .bookings-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Force 4 columns */
            gap: 15px;
            align-items: start;
        }

        .bookings-section {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 15px;
            min-height: 80vh;
        }

        .section-header { 
            border-bottom: 2px solid var(--accent-idle); 
            padding-bottom: 10px;
            margin-bottom: 15px; 
            font-size: 1.2rem; 
            font-weight: bold; 
            text-align: center;
            text-transform: uppercase;
        }
        
        .booking-row {
            background: var(--card-bg);
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-occupied);
        }

        .gap-row {
            background: rgba(255, 255, 255, 0.05);
            margin: 8px 0;
            padding: 8px;
            border-radius: 8px;
            border: 1px dashed #444;
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.85rem;
            text-align: center;
        }

        .booking-info { font-weight: 600; font-size: 1rem; display: block; margin-bottom: 4px; }
        .booking-time { font-family: monospace; color: var(--accent-idle); font-size: 0.9rem; }

        /* Modal */
        #pass-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; justify-content: center; align-items: center;
            flex-direction: column; backdrop-filter: blur(10px);
        }
        #pass-modal input { background: #2a2a2a; border: 1px solid #444; color: white; padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 8px; margin-bottom: 20px; outline: none; }
        #pass-modal button { background: var(--accent-warning); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <nav>
        <button class="tab-btn active" onclick="switchTab('status')">Live Status</button>
        <button class="tab-btn" onclick="switchTab('bookings')">Daily Schedule</button>
    </nav>

    <div id="status-view" class="view-content active">
        <div class="status-grid" id="status-grid-container"></div>
    </div>

    <div id="bookings-view" class="view-content">
        <div class="bookings-grid" id="bookings-list">
            </div>
    </div>

    <div id="pass-modal">
        <div style="color: white; margin-bottom: 20px; letter-spacing: 2px;">KIOSK LOCKED</div>
        <input type="password" id="pin-input" placeholder="••••" maxlength="4" inputmode="numeric">
        <button onclick="checkPin()">UNLOCK DEVICE</button>
    </div>

    <script>
        const API_KEY = 'AIzaSyDHxd0Ms4jv6qXcBu0Od9vm3B1IeniOtTo';
        const CALENDAR_ID = 'c_49229d9cac9c5624fe5d288c9356e492658134943d61459600373109dbf8379b@group.calendar.google.com';
        const LOCATIONS = ["Bay 1", "Bay 2", "Bay 3", "Conference"];
        const ADMIN_PIN = "1234";

        let facilityState = {}; 
        LOCATIONS.forEach(loc => {
            facilityState[loc] = { targetDate: null, isOccupied: false, allEvents: [] };
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.view-content').forEach(view => view.classList.remove('active'));
            
            const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.toLowerCase().includes(tab.replace('view','')));
            if(activeBtn) activeBtn.classList.add('active');
            
            document.getElementById(`${tab}-view`).classList.add('active');
            if(tab === 'bookings') renderBookings();
        }

        function createGrid() {
            const container = document.getElementById('status-grid-container');
            container.innerHTML = LOCATIONS.map(loc => {
                const id = loc.replace(/\s+/g, '');
                return `
                    <div class="mini-card" id="card-${id}">
                        <div class="mini-label">${loc}</div>
                        <div class="mini-title" id="title-${id}">Loading...</div>
                        <div class="mini-timer" id="timer-${id}">00:00:00</div>
                        <div class="mini-range" id="range-${id}">Synchronizing...</div>
                    </div>
                `;
            }).join('');
        }

        async function fetchAllCalendars() {
            const startOfDay = new Date();
            startOfDay.setHours(0,0,0,0);
            const endOfDay = new Date();
            endOfDay.setHours(23,59,59,999);

            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?key=${API_KEY}&timeMin=${startOfDay.toISOString()}&timeMax=${endOfDay.toISOString()}&singleEvents=true&orderBy=startTime`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                const events = data.items || [];

                LOCATIONS.forEach(loc => {
                    const locEvents = events.filter(e => (e.summary || "").toLowerCase().includes(loc.toLowerCase()));
                    processLocationData(loc, locEvents);
                });
                
                if(document.getElementById('bookings-view').classList.contains('active')) renderBookings();
                
            } catch (e) { console.error("Sync Error:", e); }
        }

        function processLocationData(loc, events) {
            const now = new Date();
            const id = loc.replace(/\s+/g, '');
            facilityState[loc].allEvents = events;

            const current = events.find(e => new Date(e.start.dateTime || e.start.date) <= now && new Date(e.end.dateTime || e.end.date) > now);
            const upcoming = events.find(e => new Date(e.start.dateTime || e.start.date) > now);

            const card = document.getElementById(`card-${id}`);
            if(!card) return;

            const titleEl = document.getElementById(`title-${id}`);
            const rangeEl = document.getElementById(`range-${id}`);
            const timeOpt = { hour: 'numeric', minute: '2-digit' };

            if (current) {
                facilityState[loc].isOccupied = true;
                facilityState[loc].targetDate = new Date(current.end.dateTime || current.end.date);
                titleEl.innerText = current.summary;
                rangeEl.innerText = `${new Date(current.start.dateTime).toLocaleTimeString([], timeOpt)} - ${new Date(current.end.dateTime).toLocaleTimeString([], timeOpt)}`;
                card.className = 'mini-card occupied-state';
            } else if (upcoming) {
                facilityState[loc].isOccupied = false;
                facilityState[loc].targetDate = new Date(upcoming.start.dateTime || upcoming.start.date);
                titleEl.innerText = "Next: " + upcoming.summary;
                rangeEl.innerText = `Starts at ${new Date(upcoming.start.dateTime).toLocaleTimeString([], timeOpt)}`;
                card.className = 'mini-card';
            } else {
                facilityState[loc].targetDate = null;
                titleEl.innerText = "Available";
                document.getElementById(`timer-${id}`).innerText = "FREE";
                rangeEl.innerText = "No more bookings today";
                card.className = 'mini-card';
            }
        }

        function updateTimers() {
            const now = new Date();
            LOCATIONS.forEach(loc => {
                const state = facilityState[loc];
                if (!state.targetDate) return;
                const diff = state.targetDate - now;
                const id = loc.replace(/\s+/g, '');
                const timerEl = document.getElementById(`timer-${id}`);
                if (diff <= 0) { fetchAllCalendars(); return; }
                const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                if(timerEl) timerEl.innerText = `${h}:${m}:${s}`;
            });
        }

        function renderBookings() {
            const list = document.getElementById('bookings-list');
            let html = '';
            const timeOpt = { hour: '2-digit', minute: '2-digit' };

            LOCATIONS.forEach(loc => {
                const events = facilityState[loc].allEvents;
                html += `<div class="bookings-section"><div class="section-header">${loc}</div>`;

                if (!events || events.length === 0) {
                    html += `<div class="gap-row">No bookings today</div>`;
                } else {
                    events.forEach((event, index) => {
                        const start = new Date(event.start.dateTime || event.start.date);
                        const end = new Date(event.end.dateTime || event.end.date);

                        if (index > 0) {
                            const prevEnd = new Date(events[index-1].end.dateTime || events[index-1].end.date);
                            const gapMs = start - prevEnd;
                            if (gapMs > 60000) { 
                                html += `<div class="gap-row">Free: ${Math.round(gapMs/60000)}m</div>`;
                            }
                        }

                        html += `
                            <div class="booking-row">
                                <span class="booking-info">${event.summary}</span>
                                <span class="booking-time">${start.toLocaleTimeString([], timeOpt)} - ${end.toLocaleTimeString([], timeOpt)}</span>
                            </div>
                        `;
                    });
                }
                html += `</div>`;
            });
            list.innerHTML = html;
        }

        function checkPin() {
            const input = document.getElementById('pin-input');
            if (input.value === ADMIN_PIN) { document.getElementById('pass-modal').style.display = 'none'; input.value = ""; }
            else { input.value = ""; input.placeholder = "WRONG PIN"; setTimeout(() => input.placeholder = "••••", 1000); }
        }

        createGrid();
        fetchAllCalendars();
        setInterval(updateTimers, 1000);
        setInterval(fetchAllCalendars, 60000);
    </script>
</body>
</html>
