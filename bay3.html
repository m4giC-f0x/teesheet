<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bay 2 Monitor</title>
    <style>
        body { background-color: #121212; color: #ffffff; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; overflow: hidden; }
        .dashboard-card { background-color: #1e1e1e; padding: 40px; border-radius: 24px; border: 4px solid #333; display: inline-block; width: 90%; max-width: 800px; margin-top: 5vh; }
        .timer { font-size: 6rem; font-weight: bold; margin: 20px 0; color: #cf6679; }
        .label { color: #a0a0a0; letter-spacing: 3px; font-weight: bold; text-transform: uppercase; }
        #debug-log { color: #555; font-size: 0.8rem; margin-top: 20px; font-family: monospace; }
        .occupied { border-color: #96cb39 !important; }
        .occupied #timer { color: #96cb39 !important; }
    </style>
</head>
<body>

    <div id="main-card" class="dashboard-card">
        <div class="label" id="top-label">Status</div>
        <div id="event-title" style="font-size: 3rem; font-weight: bold;">Loading API...</div>
        
        <div id="timer" class="timer">--:--</div>
        <div id="timer-label" class="label">Connecting...</div>

        <div id="debug-log">Log: Waiting for script...</div>
    </div>

    <script>
        // Log function to see errors on the iPad screen
        function log(msg) {
            document.getElementById('debug-log').innerText = "Log: " + msg;
        }

        var API_KEY = 'AIzaSyDHxd0Ms4jv6qXcBu0Od9vm3B1IeniOtTo';
        var CALENDAR_ID = 'c_49229d9cac9c5624fe5d288c9356e492658134943d61459600373109dbf8379b@group.calendar.google.com';
        
        function fetchCalendar() {
            log("Attempting to contact Google...");
            var url = "https://www.googleapis.com/calendar/v3/calendars/" + encodeURIComponent(CALENDAR_ID) + 
                      "/events?key=" + API_KEY + "&timeMin=" + new Date().toISOString() + 
                      "&singleEvents=true&orderBy=startTime&maxResults=3";

            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        log("Success! Data received.");
                        var data = JSON.parse(xhr.responseText);
                        updateUI(data.items || []);
                    } else {
                        log("Error: " + xhr.status + " (Check Internet/SSL)");
                    }
                }
            };

            xhr.onerror = function() {
                log("Network Failed. Check iPad Date/Time or SSL Trust.");
            };

            xhr.send();
        }

        function updateUI(items) {
            var found = null;
            for (var i = 0; i < items.length; i++) {
                if (items[i].summary.toLowerCase().indexOf("bay 2") !== -1) {
                    found = items[i];
                    break;
                }
            }

            if (found) {
                var start = new Date(found.start.dateTime || found.start.date);
                document.getElementById('event-title').innerText = found.summary;
                document.getElementById('timer-label').innerText = "Upcoming Session";
                document.getElementById('timer').innerText = start.getHours() + ":" + (start.getMinutes()<10?'0':'') + start.getMinutes();
            } else {
                document.getElementById('event-title').innerText = "Bay 2";
                document.getElementById('timer').innerText = "READY";
                document.getElementById('timer-label').innerText = "No active sessions";
            }
        }

        // Initialize
        try {
            log("Script started.");
            fetchCalendar();
            setInterval(fetchCalendar, 30000);
        } catch(e) {
            log("Critical Script Error: " + e.message);
        }
    </script>
</body>
</html>
