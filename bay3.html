<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bay 2 Monitor">
    
    <title>Bay 2 Monitor</title>
    <style>
        /* Fallback colors for older browsers that don't like CSS Variables */
        body { background-color: #121212; color: #ffffff; }

        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent-idle: #cf6679;
            --accent-occupied: #96cb39;
            --accent-warning: #cf6679;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            position: fixed; 
            touch-action: none; 
            -webkit-user-select: none;
        }

        .dashboard-card {
            background-color: #1e1e1e;
            background-color: var(--card-bg);
            padding: 30px 50px; 
            border-radius: 24px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            text-align: center;
            width: 90%;
            max-width: 850px;
            border: 2px solid transparent;
        }

        .logo-container img {
            max-height: 150px;
            max-width: 400px;  
            object-fit: contain;
        }

        .dashboard-card.occupied-state { border-color: #96cb39; border-color: var(--accent-occupied); }
        .dashboard-card.warning-state { border-color: #cf6679; border-color: var(--accent-warning); }
        .dashboard-card.idle-state { border-color: #cf6679; border-color: var(--accent-idle); }

        .label {
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 5px;
            color: #a0a0a0;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .event-title {
            font-size: 3.2rem;
            font-weight: 700;
            margin: 0 0 15px 0;
            color: #ffffff;
        }

        .timer-container {
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0; 
            border: 1px solid rgba(255,255,255,0.05);
        }

        .timer {
            font-size: 6rem; 
            font-weight: 700;
            line-height: 1;
        }

        .sub-timer {
            margin-top: 10px;
            font-size: 1.1rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .event-time {
            font-size: 1.4rem;
            color: var(--text-muted);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .status-dot {
            height: 14px;
            width: 14px;
            background-color: #03dac6;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
        }

        #pass-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <div class="dashboard-card" id="main-card">
        <div class="logo-container">
            <img src="https://m4gic-f0x.github.io/teesheet/b9.png" id="app-logo" alt="Logo">
        </div>

        <div class="label" id="top-label">Initializing...</div>
        <div class="event-title" id="event-title">---</div>
        
        <div class="timer-container">
            <div class="timer" id="timer">00:00:00</div>
            <div class="sub-timer" id="timer-label">Syncing</div>
        </div>

        <div class="event-time" id="event-time-footer">
            <span class="status-dot" id="status-dot"></span>
            <span id="time-range">Establishing Connection...</span>
        </div>
        
        <div class="error-msg" id="error-box" style="color:red; display:none;"></div>
    </div>

    <div id="pass-modal">
        <div class="label" style="color: white;">Kiosk Locked</div>
        <input type="password" id="pin-input" style="padding:15px; font-size:1.5rem; text-align:center; margin:20px 0;">
        <button onclick="checkPin()" style="padding:10px 20px; font-weight:bold;">Unlock</button>
    </div>

    <script>
        // Use older Var/Function syntax for iOS 12 compatibility
        var API_KEY = 'AIzaSyDHxd0Ms4jv6qXcBu0Od9vm3B1IeniOtTo';
        var CALENDAR_ID = 'c_49229d9cac9c5624fe5d288c9356e492658134943d61459600373109dbf8379b@group.calendar.google.com';
        var SEARCH_TERM = "Bay 2"; 
        var ADMIN_PIN = "1234";

        var currentTargetDate = null;
        var isFetching = false; 
        var isOccupied = false;
        var isUpNext = false;
        var chimePlayed0 = false;

        // Legacy AudioContext setup
        var AudioContext = window.AudioContext || window.webkitAudioContext;
        var audioCtx = AudioContext ? new AudioContext() : null;

        function playChime(freq) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            var osc = audioCtx.createOscillator();
            var gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq || 880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        // AJAX instead of Fetch for iOS 12
        function fetchCalendar() {
            if (isFetching) return;
            isFetching = true;

            var nowISO = new Date().toISOString();
            var url = "https://www.googleapis.com/calendar/v3/calendars/" + encodeURIComponent(CALENDAR_ID) + 
                      "/events?key=" + API_KEY + "&timeMin=" + nowISO + 
                      "&singleEvents=true&orderBy=startTime&q=" + encodeURIComponent(SEARCH_TERM) + "&maxResults=5";

            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    isFetching = false;
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        var validEvent = null;
                        if (data.items) {
                            for (var i = 0; i < data.items.length; i++) {
                                if (data.items[i].summary.toLowerCase().indexOf(SEARCH_TERM.toLowerCase()) > -1) {
                                    validEvent = data.items[i];
                                    break;
                                }
                            }
                        }
                        if (validEvent) processEvent(validEvent);
                        else handleNoEvents();
                    }
                }
            };
            xhr.send();
        }

        function setUIState(state) {
            var mainCard = document.getElementById('main-card');
            var timerDisplay = document.getElementById('timer');
            mainCard.className = "dashboard-card " + state + "-state";
            
            if (state === 'occupied') {
                timerDisplay.style.color = "#96cb39";
                timerDisplay.style.fontSize = "7rem";
            } else if (state === 'warning') {
                timerDisplay.style.color = "#cf6679";
                timerDisplay.style.fontSize = "7rem";
            } else {
                timerDisplay.style.color = "#cf6679";
                timerDisplay.style.fontSize = "5rem"; 
            }
        }

        function processEvent(event) {
            var start = new Date(event.start.dateTime || event.start.date);
            var end = new Date(event.end.dateTime || event.end.date);
            var now = new Date();
            var diffToStart = start - now;

            if (now >= start && now < end) {
                isOccupied = true;
                isUpNext = false;
                currentTargetDate = end;
                document.getElementById('top-label').innerText = "CURRENTLY OCCUPIED";
                document.getElementById('timer-label').innerText = "Time Remaining";
                document.getElementById('event-title').innerText = event.summary;
                document.getElementById('event-time-footer').style.visibility = "visible";
                setUIState('occupied');
            } else if (diffToStart > 0 && diffToStart <= 600000) {
                isOccupied = false;
                isUpNext = true;
                currentTargetDate = start;
                document.getElementById('top-label').innerText = "UP NEXT";
                document.getElementById('timer-label').innerText = "Starts In";
                document.getElementById('event-title').innerText = event.summary;
                document.getElementById('event-time-footer').style.visibility = "visible";
                setUIState('warning');
            } else {
                handleNoEvents();
            }
            updateTimer();
        }

        function handleNoEvents() {
            currentTargetDate = null;
            document.getElementById('top-label').innerText = "STATUS";
            document.getElementById('event-title').innerText = "Bay 2";
            document.getElementById('timer').innerText = "SESSION COMPLETE";
            document.getElementById('timer-label').innerText = ""; 
            document.getElementById('event-time-footer').style.visibility = "hidden"; 
            setUIState('idle');
            chimePlayed0 = false;
        }

        function updateTimer() {
            if (!currentTargetDate) return;
            var now = new Date();
            var diff = currentTargetDate - now;
            
            if (diff <= 0) {
                if (isOccupied && !chimePlayed0) {
                    playChime(440); chimePlayed0 = true;
                }
                fetchCalendar();
                return;
            }

            var hours = Math.floor(diff / 3600000);
            var minutes = Math.floor((diff % 3600000) / 60000);
            var seconds = Math.floor((diff % 60000) / 1000);
            
            var display = (hours > 0 ? (hours < 10 ? "0"+hours : hours) + ":" : "") + 
                          (minutes < 10 ? "0"+minutes : minutes) + ":" + 
                          (seconds < 10 ? "0"+seconds : seconds);
            document.getElementById('timer').innerText = display;
        }

        function checkPin() {
            if (document.getElementById('pin-input').value === ADMIN_PIN) {
                document.getElementById('pass-modal').style.display = 'none';
            }
        }

        // Initial calls
        fetchCalendar();
        setInterval(updateTimer, 1000);
        setInterval(fetchCalendar, 60000); 

    </script>
</body>
</html>
